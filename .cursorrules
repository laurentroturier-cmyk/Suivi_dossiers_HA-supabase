# RÃ¨gles de dÃ©veloppement - Application React/Supabase
# Suivi des dossiers HA - GestProjet

## ğŸ¯ Vue d'ensemble du projet

Application React/Vite pour le suivi des dossiers d'achats publics, intÃ©grant Supabase pour l'authentification, la gestion des rÃ´les et le stockage des donnÃ©es. L'UI utilise Tailwind CSS et lucide-react.

---

## ğŸ“ Architecture et structure des fichiers

### Structure de dossiers

```
/
â”œâ”€â”€ components/          # Composants React mÃ©tier
â”‚   â”œâ”€â”€ auth/           # Authentification (Login, AdminDashboard, DataImport)
â”‚   â”œâ”€â”€ an01/           # Module d'analyse technique
â”‚   â”œâ”€â”€ analyse/        # Composants d'analyse
â”‚   â”œâ”€â”€ dce-complet/    # Module DCE complet
â”‚   â”œâ”€â”€ redaction/      # Module de rÃ©daction (RC, NOTI1, NOTI5, etc.)
â”‚   â””â”€â”€ immobilier/     # Module immobilier
â”œâ”€â”€ pages/              # Pages principales (routing)
â”œâ”€â”€ stores/             # Stores Zustand (gestion d'Ã©tat global)
â”œâ”€â”€ hooks/              # Hooks personnalisÃ©s React
â”œâ”€â”€ services/           # Services Supabase (couche d'accÃ¨s aux donnÃ©es)
â”‚   â””â”€â”€ supabase/       # Services par domaine (projects, dossiers, contrats, etc.)
â”œâ”€â”€ utils/              # Fonctions utilitaires (parsing, formatage, etc.)
â”œâ”€â”€ design-system/      # Design system (tokens, composants UI, thÃ¨me)
â”‚   â”œâ”€â”€ tokens/         # Design tokens (colors, spacing, typography, radius, shadows)
â”‚   â”œâ”€â”€ components/     # Composants UI rÃ©utilisables (Button, Card, Input, Modal)
â”‚   â”œâ”€â”€ theme/          # Gestion du thÃ¨me (ThemeProvider, theme.css)
â”‚   â””â”€â”€ hooks/          # Hooks du design system
â”œâ”€â”€ types/              # Types TypeScript
â”œâ”€â”€ lib/                # BibliothÃ¨ques externes (supabase client)
â””â”€â”€ constants.tsx       # Constantes mÃ©tier (champs, options, etc.)
```

### Conventions de nommage

#### Fichiers
- **Composants React** : `PascalCase.tsx` (ex: `Button.tsx`, `AdminDashboard.tsx`)
- **Utilitaires** : `camelCase.ts` (ex: `dateUtils.ts`, `csvParser.ts`)
- **Services** : `camelCase.ts` (ex: `projects.ts`, `dossiers.ts`)
- **Stores** : `useXxxStore.ts` (ex: `useProjectsStore.ts`, `useAuthStore.ts`)
- **Hooks** : `useXxx.ts` (ex: `useProjects.ts`, `useAuth.ts`)
- **Types** : `camelCase.ts` ou `index.ts` dans un dossier `types/`
- **SQL** : `kebab-case.sql` (ex: `create-tables-import.sql`)
- **Documentation** : `SCREAMING_SNAKE_CASE.md` (ex: `AUTH_SETUP.md`)

#### Variables et fonctions
- **Variables** : `camelCase` (ex: `searchQuery`, `isLoading`)
- **Fonctions** : `camelCase` (ex: `loadProjects`, `formatDisplayDate`)
- **Composants React** : `PascalCase` (ex: `Button`, `AdminDashboard`)
- **Interfaces/Types** : `PascalCase` (ex: `ProjectData`, `ButtonProps`)
- **Constantes** : `SCREAMING_SNAKE_CASE` (ex: `PROJECT_FIELDS`, `DOSSIER_STATUS_OPTIONS`)
- **Colonnes SQL** : `snake_case` (ex: `numero_procedure_afpa`, `user_id`)

#### Imports
- **Utiliser l'alias `@/`** pour les imports absolus (configurÃ© dans `tsconfig.json` et `vite.config.ts`)
  ```typescript
  import { supabase } from '@/lib/supabase';
  import { useProjectsStore } from '@/stores';
  import { Button } from '@/design-system';
  ```
- **Ã‰viter les imports relatifs** (`../../`) sauf pour les fichiers trÃ¨s proches

---

## ğŸ¨ Design System et Charte Graphique

### Tokens de design

#### Couleurs
- **Palette principale** : Vert `#0f8a6a` (primary-500)
  - Utiliser les tokens du design system : `colors.primary.500`, `colors.primary.600`, etc.
  - **NE PAS hardcoder** les couleurs : Ã©viter `bg-[#0f8a6a]`, utiliser `bg-primary-500` ou variables CSS
- **Palette neutre** : Gris (`colors.neutral.*`)
- **Couleurs sÃ©mantiques** : `success`, `error`, `warning`, `info` (dÃ©finies dans `design-system/tokens/colors.ts`)
- **Mode clair/sombre** : Utiliser les variables CSS `--color-bg-primary`, `--color-text-primary`, etc.

#### Espacements
- Utiliser les tokens de spacing : `spacing[1]` (4px), `spacing[4]` (16px), `spacing[6]` (24px), etc.
- Classes Tailwind prÃ©fÃ©rÃ©es : `p-4`, `p-6`, `gap-4`, `gap-6`, etc.

#### Border-radius
- Tokens disponibles : `sm` (8px), `md` (12px), `lg` (16px), `xl` (24px), `2xl` (32px), `3xl` (40px), `full` (9999px)
- **Convention** : Utiliser des coins arrondis modernes (xl, 2xl) pour les cartes et sections principales

#### Typographie
- Police principale : `'Inter', sans-serif`
- Tailles : `xs` (12px), `sm` (14px), `base` (16px), `lg` (18px), `xl` (20px), `2xl` (24px), etc.

### Composants UI du design system

#### Utilisation
```typescript
import { Button, Card, Input, Modal } from '@/design-system';

// Button
<Button variant="primary" size="md" rounded="lg" icon={<Icon />}>
  Texte
</Button>

// Card
<Card variant="elevated" rounded="xl" padding="md" hover>
  Contenu
</Card>

// Input
<Input label="Email" error={error} helperText="Helper text" />
```

#### Variantes disponibles
- **Button** : `primary`, `secondary`, `outline`, `ghost`, `danger`
- **Card** : `elevated`, `outlined`, `filled`
- **Modal** : `sm`, `md`, `lg`, `xl`

### ThÃ¨me (dark/light)

- Utiliser le hook `useTheme` du design system :
  ```typescript
  import { useTheme } from '@/design-system';
  const { resolvedTheme, toggleTheme } = useTheme();
  ```
- Les variables CSS s'adaptent automatiquement selon le thÃ¨me
- **NE PAS** utiliser de classes hardcodÃ©es pour le dark mode : utiliser les variables CSS ou les classes Tailwind avec `dark:`

---

## âš›ï¸ Patterns React

### Composants

#### Structure d'un composant
```typescript
import React, { useState, useEffect } from 'react';
import { Button } from '@/design-system';

interface ComponentProps {
  // Props typÃ©es
}

const Component: React.FC<ComponentProps> = ({ prop1, prop2 }) => {
  // Hooks
  const [state, setState] = useState();
  
  // Effects
  useEffect(() => {
    // ...
  }, []);
  
  // Handlers
  const handleAction = () => {
    // ...
  };
  
  // Render
  return (
    <div>
      {/* JSX */}
    </div>
  );
};

export default Component;
```

#### Props
- Toujours typer les props avec une interface TypeScript
- Utiliser des valeurs par dÃ©faut pour les props optionnelles
- PrÃ©fÃ©rer la destructuration des props

### Hooks personnalisÃ©s

#### Pattern standard
```typescript
// hooks/useXxx.ts
import { useEffect } from 'react';
import { useXxxStore } from '@/stores';

export const useXxx = (autoLoad = true) => {
  const { data, loading, error, loadData } = useXxxStore();

  useEffect(() => {
    if (autoLoad && data.length === 0 && !loading) {
      loadData();
    }
  }, [autoLoad]);

  return { data, loading, error, loadData };
};
```

### Gestion d'Ã©tat

#### Zustand (stores globaux)
- Pattern standard pour les stores :
  ```typescript
  interface XxxState {
    data: XxxData[];
    loading: boolean;
    error: string | null;
    setData: (data: XxxData[]) => void;
    setLoading: (loading: boolean) => void;
    setError: (error: string | null) => void;
    loadData: () => Promise<void>;
    createData: (data: Partial<XxxData>) => Promise<void>;
    updateData: (id: string, updates: Partial<XxxData>) => Promise<void>;
    deleteData: (id: string) => Promise<void>;
  }

  export const useXxxStore = create<XxxState>((set, get) => ({
    data: [],
    loading: false,
    error: null,
    // Setters
    setData: (data) => set({ data }),
    setLoading: (loading) => set({ loading }),
    setError: (error) => set({ error }),
    // Actions async
    loadData: async () => {
      try {
        set({ loading: true, error: null });
        const data = await xxxService.getAll();
        set({ data });
      } catch (error: any) {
        set({ error: error.message });
      } finally {
        set({ loading: false });
      }
    },
    // ...
  }));
  ```

#### Ã‰tat local
- Utiliser `useState` pour l'Ã©tat local au composant
- Utiliser `useReducer` pour l'Ã©tat complexe avec plusieurs sous-Ã©tats

---

## ğŸ—„ï¸ Services Supabase

### Pattern standard pour les services

```typescript
// services/supabase/xxx.ts
import { supabase } from '@/lib/supabase';
import { XxxData } from '@/types';

export const xxxService = {
  /**
   * RÃ©cupÃ©rer tous les Ã©lÃ©ments
   */
  async getAll(): Promise<XxxData[]> {
    const { data, error } = await supabase
      .from('table_name')
      .select('*')
      .order('id', { ascending: false });

    if (error) throw error;
    return data || [];
  },

  /**
   * RÃ©cupÃ©rer un Ã©lÃ©ment par ID
   */
  async getById(id: string): Promise<XxxData> {
    const { data, error } = await supabase
      .from('table_name')
      .select('*')
      .eq('id', id)
      .single();

    if (error) throw error;
    return data;
  },

  /**
   * CrÃ©er un nouvel Ã©lÃ©ment
   */
  async create(item: Partial<XxxData>): Promise<XxxData> {
    const { data, error } = await supabase
      .from('table_name')
      .insert([item])
      .select()
      .single();

    if (error) throw error;
    return data;
  },

  /**
   * Mettre Ã  jour un Ã©lÃ©ment
   */
  async update(id: string, updates: Partial<XxxData>): Promise<XxxData> {
    const { data, error } = await supabase
      .from('table_name')
      .update(updates)
      .eq('id', id)
      .select()
      .single();

    if (error) throw error;
    return data;
  },

  /**
   * Supprimer un Ã©lÃ©ment
   */
  async delete(id: string): Promise<void> {
    const { error } = await supabase
      .from('table_name')
      .delete()
      .eq('id', id);

    if (error) throw error;
  },

  /**
   * Rechercher des Ã©lÃ©ments
   */
  async search(query: string, fields: string[] = ['field1', 'field2']): Promise<XxxData[]> {
    let queryBuilder = supabase.from('table_name').select('*');
    const orConditions = fields.map(field => `${field}.ilike.%${query}%`).join(',');
    queryBuilder = queryBuilder.or(orConditions);

    const { data, error } = await queryBuilder.order('id', { ascending: false });
    if (error) throw error;
    return data || [];
  },

  /**
   * Import en masse
   */
  async bulkInsert(items: Partial<XxxData>[]): Promise<XxxData[]> {
    const { data, error } = await supabase
      .from('table_name')
      .insert(items)
      .select();

    if (error) throw error;
    return data || [];
  },
};
```

### Gestion des erreurs
- Toujours vÃ©rifier `error` aprÃ¨s une requÃªte Supabase
- Lancer l'erreur avec `throw error` pour que le store puisse la gÃ©rer
- Logger les erreurs avec `console.error` dans les stores

---

## ğŸ› ï¸ Fonctions utilitaires

### Utilitaires de dates (`utils/dateUtils.ts`)

```typescript
// Conversion Excel â†’ Date JS
excelDateToJSDate(serial: number | string): Date | null

// Formatage pour affichage (DD/MM/YYYY)
formatDisplayDate(val: any): string

// Conversion vers format input date (YYYY-MM-DD)
formatToInputDate(val: any): string

// Conversion input date â†’ stockage (DD/MM/YYYY)
inputToStoreDate(isoDate: string): string

// DÃ©tection si un champ est une date
isDateField(fieldName: string): boolean
```

### Parsers (`utils/`)

- `csvParser.ts` : Parsing CSV
- `depotsParser.ts` : Parsing fichiers dÃ©pÃ´ts
- `retraitsParser.ts` : Parsing fichiers retraits
- `rcParser.ts` : Parsing rÃ¨glement de consultation
- `wordTemplateHandler.ts` : Gestion des templates Word

---

## ğŸ¯ Styling avec Tailwind CSS

### Classes Tailwind prÃ©fÃ©rÃ©es

#### Layout
- `flex`, `flex-col`, `flex-row`, `items-center`, `justify-between`, `gap-4`, `gap-6`
- `grid`, `grid-cols-1`, `grid-cols-2`, `grid-cols-3`

#### Spacing
- Padding : `p-4`, `p-6`, `px-4`, `py-2`
- Margin : `m-4`, `mb-6`, `mt-2`
- Gap : `gap-2`, `gap-4`, `gap-6`

#### Colors
- **Utiliser les variables CSS** : `bg-[var(--color-bg-primary)]`, `text-[var(--color-text-primary)]`
- **OU utiliser les classes Tailwind** avec dark mode : `bg-white dark:bg-gray-800`
- **Ã‰VITER** les couleurs hardcodÃ©es : `bg-[#0f8a6a]` â†’ utiliser `bg-primary-500` ou variable CSS

#### Border-radius
- `rounded-lg` (16px), `rounded-xl` (24px), `rounded-2xl` (32px)

#### Dark mode
- Toujours prÃ©voir les variantes dark : `bg-white dark:bg-gray-800`
- Utiliser les variables CSS pour la compatibilitÃ© automatique

### Variables CSS disponibles

```css
/* Backgrounds */
--color-bg-primary
--color-bg-secondary
--color-bg-tertiary

/* Text */
--color-text-primary
--color-text-secondary
--color-text-tertiary

/* Borders */
--border-strong
--border-soft
--border-subtle

/* Accents */
--accent-green
--accent-green-hover
```

---

## ğŸ” Authentification et sÃ©curitÃ©

### Supabase Auth
- Utiliser `useAuthStore` pour l'authentification
- VÃ©rifier l'utilisateur avec `supabase.auth.getUser()` dans les services
- Les politiques RLS (Row Level Security) sont gÃ©rÃ©es cÃ´tÃ© Supabase

### RÃ´les
- RÃ´les disponibles : `admin`, `user`
- VÃ©rifier les rÃ´les via `useAuthStore().profile.role`

---

## ğŸ“ Types TypeScript

### Conventions
- Toujours typer les props de composants
- Utiliser des interfaces pour les objets complexes
- Utiliser des types union pour les valeurs limitÃ©es : `type Status = 'draft' | 'published'`
- Exporter les types depuis un fichier `types.ts` ou `types/index.ts`

### Exemples
```typescript
// Types de donnÃ©es
interface ProjectData {
  IDProjet: string;
  Objet_court: string;
  // ...
}

// Props de composants
interface ButtonProps {
  variant?: 'primary' | 'secondary';
  size?: 'sm' | 'md' | 'lg';
  children: React.ReactNode;
}

// Ã‰tat de store
interface ProjectsState {
  projects: ProjectData[];
  loading: boolean;
  error: string | null;
}
```

---

## ğŸš« Anti-patterns Ã  Ã©viter

### âŒ Couleurs hardcodÃ©es
```typescript
// âŒ MAUVAIS
className="bg-[#0f8a6a] text-[#ffffff]"

// âœ… BON
className="bg-primary-500 text-white"
// OU
className="bg-[var(--accent-green)] text-[var(--text-on-accent)]"
```

### âŒ Imports relatifs profonds
```typescript
// âŒ MAUVAIS
import { supabase } from '../../../lib/supabase';

// âœ… BON
import { supabase } from '@/lib/supabase';
```

### âŒ Logique mÃ©tier dans les composants
```typescript
// âŒ MAUVAIS : Logique dans le composant
const Component = () => {
  const [data, setData] = useState([]);
  useEffect(() => {
    supabase.from('table').select('*').then(...);
  }, []);
};

// âœ… BON : Utiliser un store ou service
const Component = () => {
  const { data, loadData } = useProjects();
  useEffect(() => {
    loadData();
  }, []);
};
```

### âŒ Duplication de code
- Extraire les fonctions utilitaires communes
- Utiliser les composants du design system
- RÃ©utiliser les hooks personnalisÃ©s

### âŒ Gestion d'erreur silencieuse
```typescript
// âŒ MAUVAIS
const { data } = await supabase.from('table').select('*');

// âœ… BON
const { data, error } = await supabase.from('table').select('*');
if (error) throw error;
```

---

## âœ… Bonnes pratiques

1. **Utiliser le design system** : Toujours prÃ©fÃ©rer les composants du design system aux composants custom
2. **Typer tout** : Pas de `any` sauf cas exceptionnel avec commentaire
3. **GÃ©rer les erreurs** : Toujours gÃ©rer les erreurs dans les try/catch
4. **Loading states** : Toujours afficher un Ã©tat de chargement
5. **AccessibilitÃ©** : Utiliser les labels, aria-labels, et la sÃ©mantique HTML
6. **Performance** : Utiliser `useMemo` et `useCallback` pour les calculs coÃ»teux
7. **Documentation** : Commenter les fonctions complexes avec JSDoc

---

## ğŸ“š Ressources

- Design System : `design-system/README.md`
- Architecture : `AUDIT_ARCHITECTURE.md`
- Authentification : `AUTH_SETUP.md`
- Guide de test : `TEST_GUIDE.md`

---

**DerniÃ¨re mise Ã  jour** : 2026-01-25
